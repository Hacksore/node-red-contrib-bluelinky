<!-- Define Nodes -->
<script type="text/javascript">
  // Wrapped in a function to prevent variables from leaking into the global scope
  const bluelinkyInitNodes = () => {
    const defaultConfigs = {
      GetVehicleStatus: {
        name: { value: 'Get full status' },
        dorefresh: { value: true },
        parsed: { value: false },
        bluelinky: { value: 'Bluelinky config', type: 'bluelinky' },
        timeoutamount: { value: 0 },
        timeoutunits: { value: 's' },
        msgproperty: { value: 'payload' },
        errorproperty: { value: 'payload' },
        senderrortoaltoutput: { value: false },
        ignoremessageifpending: { value: true },
      },
      GetFullVehicleStatus: {
        name: { value: 'Get full status' },
        dorefresh: { value: true },
        bluelinky: { value: 'Bluelinky config', type: 'bluelinky' },
        timeoutamount: { value: 0 },
        timeoutunits: { value: 's' },
        msgproperty: { value: 'payload' },
        errorproperty: { value: 'payload' },
        senderrortoaltoutput: { value: false },
        ignoremessageifpending: { value: true },
      },
      Odometer: {
        name: { value: 'Get car odometer' },
        bluelinky: { value: 'Bluelinky config', type: 'bluelinky' },
        timeoutamount: { value: 0 },
        timeoutunits: { value: 's' },
        msgproperty: { value: 'payload' },
        errorproperty: { value: 'payload' },
        senderrortoaltoutput: { value: false },
        ignoremessageifpending: { value: true },
      }
    };

    /**
     * Sets any undefined/null value to the default value, excluding name and bluelinky
     */
    const applyDefaultConfig = (config, defaultConfig) => {
      Object.entries(defaultConfig).forEach(([key, { value }]) => {
        if (key === 'name' || key === 'bluelinky') {
          return;
        }
        if (config[key] == null) {
          // Set config value
          config[key] = value;
          // Update UI
          $(`#node-input-${key}`).val(value);
        }
      });
    };

    const registerBluelinkyNode = (typeName, defaultConfig) => {
      RED.nodes.registerType(typeName, {
        category: 'bluelinky',
        color: '#3FADB5',
        defaults: defaultConfig,
        inputs: 1,
        outputs: 2,
        icon: 'bluelinky.png',
        label: function () {
          return this.name || typeName;
        },
        oneditprepare: function () {
          applyDefaultConfig(this, defaultConfig);
        },
      });
    };

    // Register the nodes
    registerBluelinkyNode('car-status', defaultConfigs.GetVehicleStatus);
    registerBluelinkyNode('car-fullstatus', defaultConfigs.GetFullVehicleStatus);
    registerBluelinkyNode('car-odometer', defaultConfigs.Odometer);

  };

  bluelinkyInitNodes();
</script>

<!-- Node Template: Get Vehicle Status -->
<script type="text/html"
        data-template-name="car-status">
  <!-- Name -->
<div class="form-row">
  <label for="node-input-name"><i class="icon-tag"></i> Name</label>
  <input type="text"
         id="node-input-name"
         placeholder="Name" />
</div>

<!-- Force Refresh -->
<div class="form-row">
  <label></label>
  <input type="checkbox"
         style="display: inline-block; width: auto; vertical-align: top;"
         id="node-input-dorefresh" />
  <label for="node-input-dorefresh"
         style="width: auto;"> Refresh </label>
</div>

<!-- Parsed -->
<div class="form-row">
  <label></label>
  <input type="checkbox"
         style="display: inline-block; width: auto; vertical-align: top;"
         id="node-input-parsed" />
  <label for="node-input-parsed"
         style="width: auto;"> Parsed (Simpler object returned) </label>
</div>

<!-- Send Error To Alt Ouput -->
<div class="form-row">
  <label></label>
  <input type="checkbox"
         style="display: inline-block; width: auto; vertical-align: top;"
         id="node-input-senderrortoaltoutput" />
  <label for="node-input-senderrortoaltoutput"
         style="width: auto;"> Send error message to separate output </label>
</div>

<!-- Ignore If Pending -->
<div class="form-row">
  <label></label>
  <input type="checkbox"
         style="display: inline-block; width: auto; vertical-align: top;"
         id="node-input-ignoremessageifpending" />
  <label for="node-input-ignoremessageifpending"
         style="width: auto;"> Ignore input while request is pending </label>
</div>

<!-- Timeout -->
<div class="form-row">
  <label for="node-input-timeoutamount">Timeout</label>
  <input type="number"
         style="text-align:end; width:70px !important"
         autocomplete="off"
         id="node-input-timeoutamount" />
  <select id="node-input-timeoutunits"
          style="width:140px !important">
    <option value="s">Seconds</option>
    <option value="m">Minutes</option>
    <option value="h">Hours</option>
  </select>
</div>

<!-- Property -->
<div class="form-row">
  <label for="node-input-msgproperty">
    <i class="fa fa-ellipsis-h"></i>
    Status
  </label>
  <div style="display: inline-block; width: 10%;">
    msg.
  </div>
  <input type="text"
         style="width: 60% !important;"
         autocomplete="off"
         id="node-input-msgproperty" />
</div>

<!-- Error Property -->
<div class="form-row">
  <label for="node-input-errorproperty">
    <i class="fa fa-ellipsis-h"></i>
    Error
  </label>
  <div style="display: inline-block; width: 10%;">
    msg.
  </div>
  <input type="text"
         style="width: 60% !important;"
         autocomplete="off"
         id="node-input-errorproperty" />
</div>

<!-- Bluelink Config -->
<div class="form-row">
  <label for="node-input-bluelinky"><i class="icon-tag"></i> Config</label>
  <input type="text"
         id="node-input-bluelinky"
         placeholder="Name" />
</div>
</script>
<script type="text/html"
        data-help-name="car-status">
  <p>Get the status of the configured vehicle</p>
</script>

<!-- Node Template: Get Full Vehicle Status -->
<script type="text/html"
        data-template-name="car-fullstatus">
  <!-- Name -->
<div class="form-row">
  <label for="node-input-name"><i class="icon-tag"></i> Name</label>
  <input type="text"
         id="node-input-name"
         placeholder="Name" />
</div>

<!-- Force Refresh -->
<div class="form-row">
  <label></label>
  <input type="checkbox"
         style="display: inline-block; width: auto; vertical-align: top;"
         id="node-input-dorefresh" />
  <label for="node-input-dorefresh"
         style="width: auto;"> Refresh </label>
</div>

<!-- Send Error To Alt Ouput -->
<div class="form-row">
  <label></label>
  <input type="checkbox"
         style="display: inline-block; width: auto; vertical-align: top;"
         id="node-input-senderrortoaltoutput" />
  <label for="node-input-senderrortoaltoutput"
         style="width: auto;"> Send error message to separate output </label>
</div>

<!-- Ignore If Pending -->
<div class="form-row">
  <label></label>
  <input type="checkbox"
         style="display: inline-block; width: auto; vertical-align: top;"
         id="node-input-ignoremessageifpending" />
  <label for="node-input-ignoremessageifpending"
         style="width: auto;"> Ignore input while request is pending </label>
</div>

<!-- Timeout -->
<div class="form-row">
  <label for="node-input-timeoutamount">Timeout</label>
  <input type="number"
         style="text-align:end; width:70px !important"
         autocomplete="off"
         id="node-input-timeoutamount" />
  <select id="node-input-timeoutunits"
          style="width:140px !important">
    <option value="s">Seconds</option>
    <option value="m">Minutes</option>
    <option value="h">Hours</option>
  </select>
</div>

<!-- Property -->
<div class="form-row">
  <label for="node-input-msgproperty">
    <i class="fa fa-ellipsis-h"></i>
    Status
  </label>
  <div style="display: inline-block; width: 10%;">
    msg.
  </div>
  <input type="text"
         style="width: 60% !important;"
         autocomplete="off"
         id="node-input-msgproperty" />
</div>

<!-- Error Property -->
<div class="form-row">
  <label for="node-input-errorproperty">
    <i class="fa fa-ellipsis-h"></i>
    Error
  </label>
  <div style="display: inline-block; width: 10%;">
    msg.
  </div>
  <input type="text"
         style="width: 60% !important;"
         autocomplete="off"
         id="node-input-errorproperty" />
</div>

<!-- Bluelink Config -->
<div class="form-row">
  <label for="node-input-bluelinky"><i class="icon-tag"></i> Config</label>
  <input type="text"
         id="node-input-bluelinky"
         placeholder="Name" />
</div>
</script>
<script type="text/html"
        data-help-name="car-fullstatus">
  <p>Get the full status of the configured vehicle, always unparsed</p>
</script>

<!-- Node Template: Odometer -->
<script type="text/html"
        data-template-name="car-odometer">

  <!-- Name -->
<div class="form-row">
  <label for="node-input-name"><i class="icon-tag"></i> Name</label>
  <input type="text"
         id="node-input-name"
         placeholder="Name" />
</div>

<!-- Send Error To Alt Ouput -->
<div class="form-row">
  <label></label>
  <input type="checkbox"
         style="display: inline-block; width: auto; vertical-align: top;"
         id="node-input-senderrortoaltoutput" />
  <label for="node-input-senderrortoaltoutput"
         style="width: auto;"> Send error message to separate output </label>
</div>

<!-- Ignore If Pending -->
<div class="form-row">
  <label></label>
  <input type="checkbox"
         style="display: inline-block; width: auto; vertical-align: top;"
         id="node-input-ignoremessageifpending" />
  <label for="node-input-ignoremessageifpending"
         style="width: auto;"> Ignore input while request is pending </label>
</div>

<!-- Timeout -->
<div class="form-row">
  <label for="node-input-timeoutamount">Timeout</label>
  <input type="number"
         style="text-align:end; width:70px !important"
         autocomplete="off"
         id="node-input-timeoutamount" />
  <select id="node-input-timeoutunits"
          style="width:140px !important">
    <option value="s">Seconds</option>
    <option value="m">Minutes</option>
    <option value="h">Hours</option>
  </select>
</div>

<!-- Property -->
<div class="form-row">
  <label for="node-input-msgproperty">
    <i class="fa fa-ellipsis-h"></i>
    Status
  </label>
  <div style="display: inline-block; width: 10%;">
    msg.
  </div>
  <input type="text"
         style="width: 60% !important;"
         autocomplete="off"
         id="node-input-msgproperty" />
</div>

<!-- Error Property -->
<div class="form-row">
  <label for="node-input-errorproperty">
    <i class="fa fa-ellipsis-h"></i>
    Error
  </label>
  <div style="display: inline-block; width: 10%;">
    msg.
  </div>
  <input type="text"
         style="width: 60% !important;"
         autocomplete="off"
         id="node-input-errorproperty" />
</div>

<!-- Bluelink Config -->
<div class="form-row">
  <label for="node-input-bluelinky"><i class="icon-tag"></i> Config</label>
  <input type="text"
         id="node-input-bluelinky"
         placeholder="Name" />
</div>
</script>
<script type="text/html"
        data-help-name="car-odometer">
  <p>Get the odometer of the configured vehicle</p>
</script>

<script type="text/html"
        data-template-name="start-charge">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div class="form-row">
    <label for="node-input-bluelinky"><i class="icon-tag"></i> Config</label>
    <input type="text" id="node-input-bluelinky" placeholder="Name" />
  </div>
</script>

<script type="text/javascript">
  RED.nodes.registerType('start-car', {
    category: 'bluelinky',
    color: '#3FADB5',
    defaults: {
      name: { value: 'Start car' },
      bluelinky: { value: 'Bluelinky config', type: 'bluelinky' },
    },
    inputs: 1,
    outputs: 1,
    icon: 'bluelinky.png',
    label: function () {
      return this.name || 'start-car';
    },
  });
</script>

<script type="text/javascript">
  RED.nodes.registerType('stop-car', {
    category: 'bluelinky',
    color: '#3FADB5',
    defaults: {
      name: { value: 'Stop car' },
      bluelinky: { value: 'Bluelinky config', type: 'bluelinky' },
    },
    inputs: 1,
    outputs: 1,
    icon: 'bluelinky.png',
    label: function () {
      return this.name || 'stop-car';
    },
  });
</script>

<script type="text/javascript">
  RED.nodes.registerType('car-location', {
    category: 'bluelinky',
    color: '#3FADB5',
    defaults: {
      name: { value: 'Get car location' },
      bluelinky: { value: 'Bluelinky config', type: 'bluelinky' },
    },
    inputs: 1,
    outputs: 1,
    icon: 'bluelinky.png',
    label: function () {
      return this.name || 'car-location';
    },
  });
</script>

<script type="text/javascript">
  RED.nodes.registerType('unlock-car', {
    category: 'bluelinky',
    color: '#3FADB5',
    defaults: {
      name: { value: 'Unlock car' },
      bluelinky: { value: 'Bluelinky config', type: 'bluelinky' },
    },
    inputs: 1,
    outputs: 1,
    icon: 'bluelinky.png',
    label: function () {
      return this.name || 'unlock-car';
    },
  });
</script>

<script type="text/javascript">
  RED.nodes.registerType('lock-car', {
    category: 'bluelinky',
    color: '#3FADB5',
    defaults: {
      name: { value: 'Lock car' },
      bluelinky: { value: 'Bluelinky config', type: 'bluelinky' },
    },
    inputs: 1,
    outputs: 1,
    icon: 'bluelinky.png',
    label: function () {
      return this.name || 'lock-car';
    },
  });
</script>

<script type="text/javascript">
  RED.nodes.registerType('start-charge', {
    category: 'bluelinky',
    color: '#3FADB5',
    defaults: {
      name: { value: 'Start Charging' },
      bluelinky: { value: 'Bluelinky config', type: 'bluelinky' },
    },
    inputs: 1,
    outputs: 1,
    icon: 'bluelinky.png',
    label: function () {
      return this.name || 'start-charge';
    },
  });
</script>

<script type="text/javascript">
  RED.nodes.registerType('stop-charge', {
    category: 'bluelinky',
    color: '#3FADB5',
    defaults: {
      name: { value: 'Stop Charging' },
      bluelinky: { value: 'Bluelinky config', type: 'bluelinky' },
    },
    inputs: 1,
    outputs: 1,
    icon: 'bluelinky.png',
    label: function () {
      return this.name || 'stop-charge';
    },
  });
</script>

<script type="text/javascript">
  RED.nodes.registerType('login', {
    category: 'bluelinky',
    color: '#3FADB5',
    defaults: {
      name: { value: 'Login' },
      bluelinky: { value: 'Bluelinky config', type: 'bluelinky' },
    },
    inputs: 1,
    outputs: 1,
    icon: 'bluelinky.png',
    label: function () {
      return this.name || 'login';
    },
  });
</script>

<script type="text/javascript">
  RED.nodes.registerType('bluelinky', {
    category: 'config',
    defaults: {
      username: { required: true },
      password: { required: true },
      region: { value: 'EU', required: true },
      pin: { required: true, validate: RED.validators.number() },
      vin: { required: true },
      brand: { value: 'hyundai', required: true },
    },
    label: function () {
      return this.vin;
    },
  });
</script>


<script type="text/html"
        data-template-name="start-car">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div class="form-row">
    <label for="node-input-bluelinky"><i class="icon-tag"></i> Config</label>
    <input type="text" id="node-input-bluelinky" placeholder="Name" />
  </div>
</script>

<script type="text/html"
        data-help-name="start-car">
  <p>For ICE (Internal combustion engine) cars:</p>
  <p>Starts your engine, required config as msg.payload:</p>
  <p></p>
  <pre>
        {
            airCtrl?: boolean | string;
            igniOnDuration: number;
            airTempvalue?: number;
            defrost?: boolean | string;
            heating1?: boolean | string;
        }
    </pre
  >
  <br />
  <p>For EVs:</p>
  <p>Starts your climate, required config as msg.payload:</p>
  <p></p>
  <pre>
        {
            defrost: boolean;
            windscreenHeating: boolean;
            temperature: number;
            unit: string;
        }
    </pre
  >
</script>

<script type="text/html"
        data-template-name="stop-car">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div class="form-row">
    <label for="node-input-bluelinky"><i class="icon-tag"></i> Config</label>
    <input type="text" id="node-input-bluelinky" placeholder="Name" />
  </div>
</script>

<script type="text/html"
        data-help-name="stop-car">
  <p>For ICE (Internal combustion engine) cars:</p>
  <p>Stops your engine</p>
  <p>
    <br />
  </p>

  <p>For EVs:</p>
  <p>Stops your climate</p>
  <p></p>
</script>

<script type="text/html"
        data-template-name="car-location">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div class="form-row">
    <label for="node-input-bluelinky"><i class="icon-tag"></i> Config</label>
    <input type="text" id="node-input-bluelinky" placeholder="Name" />
  </div>
</script>

<script type="text/html"
        data-help-name="car-location">
  <p>Get the location of the configured vehicle</p>
</script>


<script type="text/html"
        data-help-name="start-charge">
  <p>Starts charging the configured vehicle</p>
</script>

<script type="text/html"
        data-template-name="stop-charge">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div class="form-row">
    <label for="node-input-bluelinky"><i class="icon-tag"></i> Config</label>
    <input type="text" id="node-input-bluelinky" placeholder="Name" />
  </div>
</script>

<script type="text/html"
        data-help-name="stop-charge">
  <p>Stops charging the configured vehicle</p>
</script>

<script type="text/html"
        data-help-name="login">
  <p>Forces bluelinky to login again</p>
</script>

<script type="text/html"
        data-template-name="login">
  <div class="form-row">
    <label for="node-input-bluelinky"><i class="icon-tag"></i> Config</label>
    <input type="text" id="node-input-bluelinky" placeholder="Name" />
  </div>
</script>

<script type="text/html"
        data-template-name="unlock-car">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div class="form-row">
    <label for="node-input-bluelinky"><i class="icon-tag"></i> Config</label>
    <input type="text" id="node-input-bluelinky" placeholder="Name" />
  </div>
</script>

<script type="text/html"
        data-help-name="unlock-car">
  <p>Unlock the configured vehicle</p>
</script>

<script type="text/html"
        data-template-name="lock-car">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div class="form-row">
    <label for="node-input-bluelinky"><i class="icon-tag"></i> Config</label>
    <input type="text" id="node-input-bluelinky" placeholder="Name" />
  </div>
</script>

<script type="text/html"
        data-help-name="lock-car">
  <p>Lock the configured vehicle</p>
</script>

<script type="text/html"
        data-template-name="bluelinky">
  <div class="form-row">
    <label for="node-config-input-name"><i class="icon-bookmark"></i> Name</label>
    <input type="text" id="node-config-input-name" value="Bluelinky" />
  </div>
  <div class="form-row">
    <label for="node-config-input-username"><i class="icon-bookmark"></i> Username</label>
    <input type="text" id="node-config-input-username" />
  </div>
  <div class="form-row">
    <label for="node-config-input-password"><i class="icon-bookmark"></i> Password</label>
    <input type="password" id="node-config-input-password" />
  </div>
  <div class="form-row">
    <label for="node-config-input-region"><i class="icon-bookmark"></i> Region</label>
    <select id="node-config-input-region">
      <option value="US">USA</option>
      <option value="EU">Europe</option>
      <option value="CA">Canada</option>
    </select>
  </div>
  <div class="form-row">
    <label for="node-config-input-pin"><i class="icon-bookmark"></i> Pin</label>
    <input type="password" id="node-config-input-pin" />
  </div>
  <div class="form-row">
    <label for="node-config-input-vin"><i class="icon-bookmark"></i> Vin</label>
    <input type="text" id="node-config-input-vin" />
  </div>
  <div class="form-row">
    <label for="node-config-input-brand"><i class="icon-bookmark"></i> Brand</label>
    <select id="node-config-input-brand">
      <option value="kia">Kia</option>
      <option value="hyundai">Hyundai</option>
    </select>
  </div>
</script>
